name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_integration_tests:
        description: 'Run integration tests (admin only)'
        required: false
        type: boolean
        default: false
      force_retry:
        description: 'Force retry even if rate limited'
        required: false
        type: boolean
        default: false
# Auto-cancel outdated runs for PRs
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION_DEFAULT: "3.13"
  RATE_LIMIT_MARKER_FILE: ".github/.rate_limit_marker"

jobs:
  # Job 1: Lint (fast fail)
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-suffix: lint

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ruff
        run: uv run ruff check .

      - name: Run mypy
        run: uv run mypy src/pymoogo --show-error-codes

  # Job 2: Unit Tests (parallel matrix)
  test-unit:
    name: Unit Tests - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: lint  # Lint must pass first
    strategy:
      fail-fast: false  # Don't cancel other versions if one fails
      matrix:
        python-version: ['3.13', '3.14']

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-suffix: test-${{ matrix.python-version }}

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run unit tests with retry
        id: unit-tests
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: |
            uv run pytest tests/ -v -m unit \
              --cov=src/pymoogo \
              --cov-report=xml \
              --cov-report=term \
              --cov-report=html \
              --junitxml=junit-${{ matrix.python-version }}.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: matrix.python-version == env.PYTHON_VERSION_DEFAULT
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            junit-${{ matrix.python-version }}.xml
            htmlcov/
          retention-days: 30

  # Job 3: Check Rate Limit Status
  check-rate-limit:
    name: Check Rate Limit Status
    runs-on: ubuntu-latest
    if: github.event.inputs.run_integration_tests == 'true'
    outputs:
      rate_limited: ${{ steps.check-limit.outputs.rate_limited }}
      can_proceed: ${{ steps.check-limit.outputs.can_proceed }}
      time_until_retry: ${{ steps.check-limit.outputs.time_until_retry }}
      last_failure_time: ${{ steps.check-limit.outputs.last_failure_time }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need history for checking rate limit marker

      - name: Check rate limit marker
        id: check-limit
        run: |
          MARKER_FILE="${{ env.RATE_LIMIT_MARKER_FILE }}"
          RATE_LIMITED="false"
          CAN_PROCEED="true"
          TIME_UNTIL_RETRY="0"
          LAST_FAILURE=""

          # Check if rate limit marker exists
          if [ -f "$MARKER_FILE" ]; then
            LAST_FAILURE=$(cat "$MARKER_FILE")
            LAST_FAILURE_EPOCH=$(date -d "$LAST_FAILURE" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S" "$LAST_FAILURE" +%s 2>/dev/null || echo "0")
            CURRENT_EPOCH=$(date +%s)
            TIME_DIFF=$((CURRENT_EPOCH - LAST_FAILURE_EPOCH))

            # 24 hours = 86400 seconds
            if [ "$TIME_DIFF" -lt 86400 ]; then
              RATE_LIMITED="true"
              CAN_PROCEED="false"
              TIME_UNTIL_RETRY=$((86400 - TIME_DIFF))

              echo "::warning::Rate limit detected. Last failure: $LAST_FAILURE"
              echo "::warning::Time until retry allowed: $((TIME_UNTIL_RETRY / 3600)) hours, $(((TIME_UNTIL_RETRY % 3600) / 60)) minutes"
            else
              echo "::notice::Rate limit window expired. Can proceed with integration tests."
              CAN_PROCEED="true"
              # Remove marker file
              rm -f "$MARKER_FILE"
            fi
          else
            echo "::notice::No rate limit marker found. Can proceed with integration tests."
          fi

          # Check for force_retry input
          if [ "${{ github.event.inputs.force_retry }}" == "true" ]; then
            echo "::warning::Force retry requested. Overriding rate limit check."
            CAN_PROCEED="true"
            RATE_LIMITED="false"
          fi

          echo "rate_limited=$RATE_LIMITED" >> $GITHUB_OUTPUT
          echo "can_proceed=$CAN_PROCEED" >> $GITHUB_OUTPUT
          echo "time_until_retry=$TIME_UNTIL_RETRY" >> $GITHUB_OUTPUT
          echo "last_failure_time=$LAST_FAILURE" >> $GITHUB_OUTPUT

      - name: Create rate limit summary
        run: |
          echo "## Rate Limit Status ðŸš¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-limit.outputs.rate_limited }}" == "true" ]; then
            echo "â›” **RATE LIMITED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Last failure: ${{ steps.check-limit.outputs.last_failure_time }}" >> $GITHUB_STEP_SUMMARY
            echo "- Time until retry: $(($${{ steps.check-limit.outputs.time_until_retry }} / 3600)) hours" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Integration tests can be manually retried after 24 hours via workflow_dispatch." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **NO RATE LIMIT**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Integration tests can proceed normally." >> $GITHUB_STEP_SUMMARY
          fi

  # Job 4: Integration Tests (optional, protected, with resilience)
  test-integration:
    name: Integration Tests - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: [lint, test-unit, check-rate-limit]
    if: |
      github.event.inputs.run_integration_tests == 'true' &&
      needs.check-rate-limit.outputs.can_proceed == 'true'
    environment: integration-tests  # Requires admin approval
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.13', '3.14']

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-suffix: integration-${{ matrix.python-version }}

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run integration tests with rate limit handling
        id: integration-tests
        continue-on-error: true  # Don't fail job immediately
        env:
          # Multi-layer secret protection
          MOOGO_EMAIL: ${{ secrets.MOOGO_EMAIL }}
          MOOGO_PASSWORD: ${{ secrets.MOOGO_PASSWORD }}
          MOOGO_CACHED_TOKEN: ${{ secrets.MOOGO_CACHED_TOKEN }}
          MOOGO_CACHED_USER_ID: ${{ secrets.MOOGO_CACHED_USER_ID }}
          MOOGO_CACHED_EXPIRES: ${{ secrets.MOOGO_CACHED_EXPIRES }}
        run: |
          set +e  # Don't exit on error

          # Run tests and capture output
          uv run pytest tests/ -v -m integration \
            --cov=src/pymoogo \
            --cov-report=xml \
            --cov-report=term \
            --capture=no \
            --tb=short 2>&1 | tee integration_test_output.txt

          TEST_EXIT_CODE=$?

          # Check for rate limit errors in output
          if grep -q "Rate limited" integration_test_output.txt || grep -q "10000" integration_test_output.txt; then
            echo "::error::Rate limit detected in test output!"
            echo "rate_limit_detected=true" >> $GITHUB_OUTPUT
            echo "test_failed=true" >> $GITHUB_OUTPUT
            exit 1
          elif [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "::warning::Tests failed but not due to rate limiting"
            echo "rate_limit_detected=false" >> $GITHUB_OUTPUT
            echo "test_failed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "::notice::Integration tests passed successfully"
            echo "rate_limit_detected=false" >> $GITHUB_OUTPUT
            echo "test_failed=false" >> $GITHUB_OUTPUT

            # Check if .env was updated with new cached session
            if [ -f .env ]; then
              echo "::notice::Session cache status: Check logs for authentication details"

              # Export new cached values as outputs (MASKED for security)
              if grep -q "MOOGO_CACHED_TOKEN" .env; then
                CACHED_TOKEN=$(grep MOOGO_CACHED_TOKEN .env | cut -d'=' -f2)
                CACHED_USER_ID=$(grep MOOGO_CACHED_USER_ID .env | cut -d'=' -f2)
                CACHED_EXPIRES=$(grep MOOGO_CACHED_EXPIRES .env | cut -d'=' -f2)

                # CRITICAL: Mask secrets before output
                echo "::add-mask::$CACHED_TOKEN"
                echo "::add-mask::$CACHED_USER_ID"

                echo "cached_token=$CACHED_TOKEN" >> $GITHUB_OUTPUT
                echo "cached_user_id=$CACHED_USER_ID" >> $GITHUB_OUTPUT
                echo "cached_expires=$CACHED_EXPIRES" >> $GITHUB_OUTPUT
                echo "session_refreshed=true" >> $GITHUB_OUTPUT
              fi
            fi
            exit 0
          fi

      - name: Mark rate limit if detected
        if: steps.integration-tests.outputs.rate_limit_detected == 'true'
        run: |
          mkdir -p .github
          date "+%Y-%m-%d %H:%M:%S" > ${{ env.RATE_LIMIT_MARKER_FILE }}

          echo "::error::Rate limit detected! Marking for 24-hour cooldown."
          echo "::notice::Retry manually after 24 hours via workflow_dispatch."

          # Commit marker file if on main branch
          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add ${{ env.RATE_LIMIT_MARKER_FILE }}
            git commit -m "chore: Mark rate limit detected [skip ci]"
            git push
          fi

      - name: Create rate limit issue
        if: steps.integration-tests.outputs.rate_limit_detected == 'true' && github.event_name != 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¦ API Rate Limit Detected - 24h Cooldown Active',
              body: `## Rate Limit Detected

              The Moogo API integration tests have triggered a rate limit error.

              **Details:**
              - Detected at: ${new Date().toISOString()}
              - Workflow: ${context.workflow}
              - Run ID: ${context.runId}

              **Action Required:**
              - Integration tests can be manually retried after 24 hours via workflow_dispatch
              - Use the "Run workflow" button in Actions tab with "Run integration tests" enabled

              This issue will be automatically closed when tests pass successfully.`,
              labels: ['automated', 'rate-limit', 'integration-tests']
            });

            console.log('Created issue:', issue.data.number);

      - name: Fail job if tests failed
        if: steps.integration-tests.outputs.test_failed == 'true'
        run: |
          if [ "${{ steps.integration-tests.outputs.rate_limit_detected }}" == "true" ]; then
            echo "::error::Integration tests failed due to rate limiting. Will retry in 24 hours."
          else
            echo "::error::Integration tests failed due to non-rate-limit errors."
          fi
          exit 1

      - name: Update cached session secrets automatically
        if: steps.integration-tests.outputs.session_refreshed == 'true' && github.event_name != 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::warning::PAT_TOKEN not configured. Skipping automatic secret update."
            echo "::notice::To enable automatic updates, configure PAT_TOKEN secret"
            exit 0
          fi

          echo "::warning::Session refreshed. Updating GitHub secrets automatically..."

          # Update secrets using gh CLI with PAT (secrets are already masked)
          echo "${{ steps.integration-tests.outputs.cached_token }}" | gh secret set MOOGO_CACHED_TOKEN
          echo "${{ steps.integration-tests.outputs.cached_user_id }}" | gh secret set MOOGO_CACHED_USER_ID
          echo "${{ steps.integration-tests.outputs.cached_expires }}" | gh secret set MOOGO_CACHED_EXPIRES

          echo "::notice::âœ“ GitHub secrets updated successfully!"
          echo "::notice::Session valid until: ${{ steps.integration-tests.outputs.cached_expires }}"

      - name: Close rate limit issues on success
        if: steps.integration-tests.outputs.test_failed == 'false' && github.event_name != 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            // Find open rate limit issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'rate-limit'
            });

            // Close all rate limit issues
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… Integration tests passed successfully. Rate limit window has expired. Closing automatically.'
              });

              console.log('Closed rate limit issue:', issue.number);
            }

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: matrix.python-version == env.PYTHON_VERSION_DEFAULT && steps.integration-tests.outputs.test_failed == 'false'
        with:
          files: ./coverage.xml
          flags: integration
          name: codecov-integration-${{ matrix.python-version }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test output artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: integration-test-output-${{ matrix.python-version }}
          path: |
            integration_test_output.txt
            .env
          retention-days: 7

  # Job 5: Build & Validate Package
  build:
    name: Build & Validate Package
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-integration]
    # Build if lint and unit tests pass (integration tests are optional or skipped due to rate limit)
    if: |
      always() &&
      needs.lint.result == 'success' &&
      needs.test-unit.result == 'success' &&
      (needs.test-integration.result == 'success' ||
       needs.test-integration.result == 'skipped' ||
       needs.test-integration.result == 'failure')

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-suffix: build

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Build package
        run: uv build

      - name: Validate package metadata
        run: uvx twine check dist/*

      - name: Check package contents
        run: |
          echo "::group::Package Contents"
          tar -tzf dist/*.tar.gz | head -50
          echo "::endgroup::"

      - name: Test package installation
        run: |
          # Create isolated venv and test install
          uv venv .test-venv
          source .test-venv/bin/activate
          uv pip install dist/*.whl
          python -c "import pymoogo; print(f'Version: {pymoogo.__version__}')"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: dist
          path: dist/
          retention-days: 90  # Keep for 3 months

      - name: Upload package metadata
        uses: actions/upload-artifact@v5
        with:
          name: package-metadata
          path: |
            pyproject.toml
            README.md
            LICENSE
          retention-days: 90

  # Job 6: Security Scanning (optional, informational)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true  # Don't fail CI on security issues
    permissions:
      security-events: write
      contents: read

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run pip-audit
        run: |
          uvx pip-audit --desc --skip-editable || true

  # Summary job for branch protection
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-integration, build]
    if: always()
    steps:
      - name: Check CI status
        id: check-status
        run: |
          LINT_STATUS="${{ needs.lint.result }}"
          UNIT_STATUS="${{ needs.test-unit.result }}"
          INTEGRATION_STATUS="${{ needs.test-integration.result }}"
          BUILD_STATUS="${{ needs.build.result }}"

          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "integration_status=$INTEGRATION_STATUS" >> $GITHUB_OUTPUT
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT

          # Check required jobs
          if [ "$LINT_STATUS" != "success" ]; then
            echo "::error::Lint failed"
            exit 1
          fi

          if [ "$UNIT_STATUS" != "success" ]; then
            echo "::error::Unit tests failed"
            exit 1
          fi

          if [ "$BUILD_STATUS" != "success" ]; then
            echo "::error::Build failed"
            exit 1
          fi

          # Integration tests are optional - skipped/failure due to rate limit is OK
          if [ "$INTEGRATION_STATUS" == "failure" ]; then
            echo "::warning::Integration tests failed (possibly due to rate limiting)"
            echo "::notice::This is acceptable for PR approval. Retry manually via workflow_dispatch."
          elif [ "$INTEGRATION_STATUS" == "skipped" ]; then
            echo "::notice::Integration tests skipped (not requested or rate limited)"
          fi

          echo "::notice::âœ“ All required CI checks passed!"

      - name: Create summary
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Required checks
          echo "### Required Checks âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ steps.check-status.outputs.lint_status == 'success' && 'âœ…' || 'âŒ' }} ${{ steps.check-status.outputs.lint_status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ steps.check-status.outputs.unit_status == 'success' && 'âœ…' || 'âŒ' }} ${{ steps.check-status.outputs.unit_status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ steps.check-status.outputs.build_status == 'success' && 'âœ…' || 'âŒ' }} ${{ steps.check-status.outputs.build_status }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Optional Checks" >> $GITHUB_STEP_SUMMARY

          INTEGRATION_STATUS="${{ steps.check-status.outputs.integration_status }}"
          if [ "$INTEGRATION_STATUS" == "success" ]; then
            echo "- Integration Tests: âœ… success" >> $GITHUB_STEP_SUMMARY
          elif [ "$INTEGRATION_STATUS" == "failure" ]; then
            echo "- Integration Tests: âš ï¸ failed (may be rate limited)" >> $GITHUB_STEP_SUMMARY
          elif [ "$INTEGRATION_STATUS" == "skipped" ]; then
            echo "- Integration Tests: â­ï¸ skipped (not requested or rate limited)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Result:** All required checks passed. Safe to merge! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
